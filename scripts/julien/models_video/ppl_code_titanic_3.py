import os
import pandas as pd
import pymc3 as pm
import numpy as np
import theano.tensor as tt
from theano.ifelse import ifelse
from mb_modelbase.models_core.pyMC3_model import ProbabilisticPymc3Model


def create_fun():
    def code_to_fit(file='../data/titanic_cleaned.csv', modelname='titanic_3', fit=True, dtm=None, pp_graph=None):
        # income is gaussian, depends on age
        filepath = os.path.join(os.path.dirname(__file__), '../data/titanic_cleaned.csv')
        df_model_repr = pd.read_csv(filepath)
        df_orig = dtm.backward(df_model_repr, inplace=False)
        if fit:
            modelname = modelname + '_fitted'
        # Set up shared variables

        model = pm.Model()
        data = None
        with model:
            survived = pm.Categorical('survived', p=[0.0185, 0.9815])
            sex = pm.Categorical('sex', p=tt.switch(tt.eq(survived, 0), [0.5, 0.5], [0.5, 0.5]))
            ticket = pm.Categorical('ticket', p=[0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872, 0.003022455089822872, 0.003022455089822872,
                                                 0.003022455089822872])
            pclass = pm.Categorical('pclass', p=tt.switch(tt.eq(sex, 0),
                                                          [0.3348999999999999, 0.3348999999999999, 0.3348999999999999],
                                                          [0.3348999999999999, 0.3348999999999999, 0.3348999999999999]))
            fare = pm.Normal('fare', mu=tt.switch(tt.eq(sex, 0), tt.switch(tt.eq(pclass, 0), 54.949035714285735,
                                                                           tt.switch(tt.eq(pclass, 1),
                                                                                     54.949035714285735,
                                                                                     54.949035714285735)),
                                                  tt.switch(tt.eq(pclass, 0), 54.949035714285735,
                                                            tt.switch(tt.eq(pclass, 1), 54.949035714285735,
                                                                      54.949035714285735))),
                             sigma=tt.switch(tt.eq(sex, 0), tt.switch(tt.eq(pclass, 0), 48.249042857142854,
                                                                      tt.switch(tt.eq(pclass, 1), 48.249042857142854,
                                                                                48.249042857142854)),
                                             tt.switch(tt.eq(pclass, 0), 48.249042857142854,
                                                       tt.switch(tt.eq(pclass, 1), 48.249042857142854,
                                                                 48.249042857142854))))
            embarked = pm.Categorical('embarked', p=tt.switch(tt.eq(pclass, 0), [0.2638411764705882, 0.2638411764705882,
                                                                                 0.2638411764705882],
                                                              tt.switch(tt.eq(pclass, 1),
                                                                        [0.2638411764705882, 0.2638411764705882,
                                                                         0.2638411764705882],
                                                                        [0.2638411764705882, 0.2638411764705882,
                                                                         0.2638411764705882])))
            boat = pm.Categorical('boat', p=tt.switch(tt.eq(pclass, 0),
                                                      [0.037041975308641756, 0.037041975308641756, 0.037041975308641756,
                                                       0.037041975308641756, 0.037041975308641756, 0.037041975308641756,
                                                       0.037041975308641756, 0.037041975308641756, 0.037041975308641756,
                                                       0.037041975308641756, 0.037041975308641756, 0.037041975308641756,
                                                       0.037041975308641756, 0.037041975308641756, 0.037041975308641756,
                                                       0.037041975308641756, 0.037041975308641756, 0.037041975308641756,
                                                       0.037041975308641756, 0.037041975308641756, 0.037041975308641756,
                                                       0.037041975308641756, 0.037041975308641756, 0.037041975308641756,
                                                       0.037041975308641756, 0.037041975308641756,
                                                       0.037041975308641756], tt.switch(tt.eq(pclass, 1),
                                                                                        [0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756],
                                                                                        [0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756,
                                                                                         0.037041975308641756])))
            has_cabin_number = pm.Categorical('has_cabin_number', p=tt.switch(tt.eq(pclass, 0), [0.5, 0.5],
                                                                              tt.switch(tt.eq(pclass, 1), [0.5, 0.5],
                                                                                        [0.5, 0.5])))
            age = pm.Normal('age', mu=tt.switch(tt.eq(embarked, 0), tt.switch(tt.eq(pclass, 0), 36.3462,
                                                                              tt.switch(tt.eq(pclass, 1), 20.5921,
                                                                                        20.5546)),
                                                tt.switch(tt.eq(embarked, 1), tt.switch(tt.eq(pclass, 0), 35.0,
                                                                                        tt.switch(tt.eq(pclass, 1),
                                                                                                  29.9406, 27.8244)),
                                                          tt.switch(tt.eq(pclass, 0), 35.7486,
                                                                    tt.switch(tt.eq(pclass, 1), 25.458, 23.4376)))),
                            sigma=tt.switch(tt.eq(embarked, 0), tt.switch(tt.eq(pclass, 0), 12.6923,
                                                                          tt.switch(tt.eq(pclass, 1), 10.5268,
                                                                                    11.7445)),
                                            tt.switch(tt.eq(embarked, 1), tt.switch(tt.eq(pclass, 0), 2.8284,
                                                                                    tt.switch(tt.eq(pclass, 1), 0.0841,
                                                                                              4.2584)),
                                                      tt.switch(tt.eq(pclass, 0), 14.5895,
                                                                tt.switch(tt.eq(pclass, 1), 14.4234, 11.2448)))))

        m = ProbabilisticPymc3Model(modelname, model, data_mapping=dtm, probabilistic_program_graph=pp_graph)
        m.nr_of_posterior_samples = 1000
        if fit:
            m.fit(df_orig, auto_extend=False)
        return df_orig, m

    return code_to_fit
